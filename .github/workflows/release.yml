name: Create Release Executable

# Si attiva SOLO quando spingi un tag che inizia con 'v' (es. v1.0, v2.0.1)
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # Fondamentale per permettere all'action di creare la Release

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    # 1. Scarica il codice
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Setup Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    # 3. Dipendenze
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 numpy pyinstaller

    # 4. Scarica e Configura FFmpeg (Automatico)
    - name: Download and Setup FFmpeg
      run: |
        echo "Downloading FFmpeg..."
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        
        echo "Extracting..."
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath ".\ffmpeg_temp"
        
        echo "Moving binaries..."
        # Sposta i file exe dalla cartella estratta alla root del progetto
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffmpeg.exe" -Destination ".\ffmpeg.exe"
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffprobe.exe" -Destination ".\ffprobe.exe"
        
        echo "Cleanup..."
        Remove-Item "ffmpeg.zip"
        Remove-Item "ffmpeg_temp" -Recurse -Force

    # 5. Compila l'EXE
    - name: Build with PyInstaller
      run: |
        python -m PyInstaller --noconsole --onefile --name "AudioMerger" --add-binary "ffmpeg.exe;." --add-binary "ffprobe.exe;." mixer.py

    # 6. CREA LA RELEASE E CARICA IL FILE
    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/AudioMerger.exe
        generate_release_notes: true
        make_latest: true