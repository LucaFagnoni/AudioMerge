name: Create Release Executable

on:
  push:
    tags:
      - 'v*' # Si attiva solo quando crei un tag (es. v1.2.0)

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    # 1. Scarica il codice
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Imposta Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 3. Installa dipendenze
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 pyinstaller

    # 4. Scarica ed estrae FFmpeg (per non appesantire il repo git)
    - name: Download and Setup FFmpeg
      run: |
        echo "Downloading FFmpeg..."
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        
        echo "Extracting..."
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath ".\ffmpeg_temp"
        
        echo "Moving binaries..."
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffmpeg.exe" -Destination ".\ffmpeg.exe"
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffprobe.exe" -Destination ".\ffprobe.exe"
        
        echo "Cleanup..."
        Remove-Item "ffmpeg.zip"
        Remove-Item "ffmpeg_temp" -Recurse -Force

    # 5. Compila l'EXE con PyInstaller
    - name: Build with PyInstaller
      run: |
        python -m PyInstaller --noconsole --onefile --name "MixCut" `
          --icon "app_icon.ico" `
          --add-data "app_icon.ico;." `
          --add-data "icons;icons" `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --exclude-module numpy `
          --exclude-module matplotlib `
          --exclude-module tkinter `
          --exclude-module pandas `
          --exclude-module scipy `
          --exclude-module PyQt6.QtWebEngine `
          --exclude-module PyQt6.QtWebEngineCore `
          --exclude-module PyQt6.QtWebEngineWidgets `
          --exclude-module PyQt6.QtSql `
          --exclude-module PyQt6.QtQml `
          --exclude-module PyQt6.QtQuick `
          main.py

    # 6. Crea la Release su GitHub e carica il file
    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/MixCut.exe
        generate_release_notes: true
        make_latest: true