name: Create Release Executable

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Installiamo solo PyQt6 e PyInstaller (Niente NumPy)
        pip install PyQt6 pyinstaller

    - name: Download and Setup FFmpeg
      run: |
        echo "Downloading FFmpeg..."
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath ".\ffmpeg_temp"
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffmpeg.exe" -Destination ".\ffmpeg.exe"
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffprobe.exe" -Destination ".\ffprobe.exe"
        Remove-Item "ffmpeg.zip"
        Remove-Item "ffmpeg_temp" -Recurse -Force

    - name: Build with PyInstaller
      run: |
        # Configurazione OTTIMIZZATA:
        # - Exclude QtWebEngine (pesante e inutile qui)
        # - Exclude NumPy/Matplotlib/Tkinter
        # - MANTIENE QtNetwork/QtMultimedia (essenziali per l'audio)
        python -m PyInstaller --noconsole --onefile --name "AudioMerge" --add-binary "ffmpeg.exe;." --add-binary "ffprobe.exe;." --exclude-module numpy --exclude-module matplotlib --exclude-module tkinter --exclude-module unittest --exclude-module email --exclude-module http --exclude-module xml --exclude-module pydoc --exclude-module PyQt6.QtWebEngine --exclude-module PyQt6.QtWebEngineCore --exclude-module PyQt6.QtWebEngineWidgets --exclude-module PyQt6.QtSql mixer.py

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/AudioMerge.exe
        generate_release_notes: true
        make_latest: true