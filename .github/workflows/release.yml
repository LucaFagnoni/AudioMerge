name: Create Release Executables

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 pyinstaller

    # Scarica FFmpeg (serve per la versione Standalone)
    - name: Download and Setup FFmpeg
      run: |
        echo "Downloading FFmpeg..."
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        
        echo "Extracting..."
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath ".\ffmpeg_temp"
        
        echo "Moving binaries..."
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffmpeg.exe" -Destination ".\ffmpeg.exe"
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffprobe.exe" -Destination ".\ffprobe.exe"
        
        echo "Cleanup..."
        Remove-Item "ffmpeg.zip"
        Remove-Item "ffmpeg_temp" -Recurse -Force

    # --- BUILD 1: STANDALONE (Con FFmpeg integrato) ---
    - name: Build Standalone EXE
      run: |
        python -m PyInstaller --noconsole --onefile --name "MixCut_standalone" `
          --icon "app_icon.ico" `
          --add-data "app_icon.ico;." `
          --add-data "icons;icons" `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --exclude-module numpy `
          --exclude-module matplotlib `
          --exclude-module tkinter `
          --exclude-module pandas `
          --exclude-module scipy `
          --exclude-module PyQt6.QtWebEngine `
          --exclude-module PyQt6.QtWebEngineCore `
          --exclude-module PyQt6.QtWebEngineWidgets `
          --exclude-module PyQt6.QtSql `
          --exclude-module PyQt6.QtQml `
          --exclude-module PyQt6.QtQuick `
          main.py

    # --- BUILD 2: LITE (Senza FFmpeg, usa quello di sistema) ---
    # Nota: Rimuoviamo --add-binary per ffmpeg e ffprobe
    - name: Build Lite EXE
      run: |
        python -m PyInstaller --noconsole --onefile --name "MixCut_lite" `
          --icon "app_icon.ico" `
          --add-data "app_icon.ico;." `
          --add-data "icons;icons" `
          --exclude-module numpy `
          --exclude-module matplotlib `
          --exclude-module tkinter `
          --exclude-module pandas `
          --exclude-module scipy `
          --exclude-module PyQt6.QtWebEngine `
          --exclude-module PyQt6.QtWebEngineCore `
          --exclude-module PyQt6.QtWebEngineWidgets `
          --exclude-module PyQt6.QtSql `
          --exclude-module PyQt6.QtQml `
          --exclude-module PyQt6.QtQuick `
          main.py

    # Carica entrambi i file nella Release
    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          dist/MixCut_standalone.exe
          dist/MixCut_lite.exe
        generate_release_notes: true
        make_latest: true