name: Create Release Executable

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # RIMOSTA la riga "cache: pip" per evitare l'errore se manca requirements.txt
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 numpy pyinstaller

    - name: Download and Setup FFmpeg
      run: |
        echo "Downloading FFmpeg..."
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        
        echo "Extracting..."
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath ".\ffmpeg_temp"
        
        echo "Moving binaries..."
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffmpeg.exe" -Destination ".\ffmpeg.exe"
        Move-Item -Path ".\ffmpeg_temp\ffmpeg-*-essentials_build\bin\ffprobe.exe" -Destination ".\ffprobe.exe"
        
        echo "Cleanup..."
        Remove-Item "ffmpeg.zip"
        Remove-Item "ffmpeg_temp" -Recurse -Force

    - name: Build with PyInstaller
      run: |
        # Assicurati che il tuo script si chiami 'mixer.py' nel repository
        python -m PyInstaller --noconsole --onefile --name "AudioMerger" --add-binary "ffmpeg.exe;." --add-binary "ffprobe.exe;." mixer.py

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/AudioMerger.exe
        generate_release_notes: true
        make_latest: true